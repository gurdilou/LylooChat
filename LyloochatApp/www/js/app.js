function App(t){function n(){this.model.options={},this.model.options.prefix=""}this.loaded=!1,this.views={},this.model={},this.deviceHandler=t,this.soundLibrary=void 0,Handlebars.registerPartial("widget_badge_button",Lyloochat.templates.widget_badge_button),Handlebars.registerPartial("widget_text_button",Lyloochat.templates.widget_text_button),Handlebars.registerPartial("widget_floating_button",Lyloochat.templates.widget_floating_button),this.initialisation=function(){console.log("initialisation"),$.event.special.tap.emitTapOnTaphold=!1;var e=this;showLoadingPanel("Chargement des cartes..."),this.model.listCards=new ListCards,t.loadCards(this.model.listCards,function(){n.call(e),e.views.menu=new AppMenu(e),e.views.grid=new AppGrid(e),e.loaded=!0,hideLoadingPanel()}),window.onerror=function(t,n,e,i,a){console.error(t),showErrorPanel(t)}},this.getSoundLibrary=function(n){if(void 0!==i)n(i);else{var e=this,i=new SoundLibrary(this);showLoadingPanel("Chargement des sons..."),t.loadSounds(i,function(){hideLoadingPanel(),e.soundLibrary=i,n(e.soundLibrary)})}},this.saveRecentsSound=function(n,e){t.saveRecentsSound(n,e)}}function showMaskPanel(t){$.inner_showMaskPanel(this,!0,t)}function showModalMaskPanel(){$.inner_showMaskPanel(this,!1,void 0)}function hideMaskPanel(){$.inner_hideMaskPanel(this)}function showPopupPanel(){$.inner_showPopupPanel(this)}function hidePopupPanel(){$.inner_hidePopupPanel(this)}function showErrorPanel(t){$.inner_showErrorPanel(this,t,hideErrorPanel)}function hideErrorPanel(){$.inner_hideErrorPanel(this)}function showLoadingPanel(t){$.inner_showLoadingPanel(this,t,hideLoadingPanel)}function hideLoadingPanel(){$.inner_hideLoadingPanel(this)}function Card(t,n){this.id=t,this.code=n}function Card_Drawing(t,n,e){this.svg=e,Card.apply(this,[t,n])}function Card_Sound(t,n,e){this.filepath=e,Card.apply(this,[t,n])}function Card_Text(t,n,e){this.label=e,Card.apply(this,[t,n])}function ListCards(){this.cards=[],this.addCard=function(t){this.cards.push(t)},this.length=function(){return this.cards.length},this.getCard=function(t){return this.cards[t]},this.replaceCard=function(t,n){this.cards[t]=n}}function Sound(t,n,e,i){function a(t,n){var e=n-t.toString().length+1;return Array(+(e>0&&e)).join("0")+t}this.library=void 0,this.name=t,this.author=n,this.filepath=e,this.duration=i,this.getDurationStr=function(){var t=new Date(1e3*i),n=t.getMinutes();n=a.call(this,n,2);var e=t.getSeconds();return e=a.call(this,e,2),n+":"+e}}function SoundLibrary(t){this.recents_played=new SoundList(this),this.all_sounds=new SoundList(this),this.ready=!1,this.app=t,this.searchSounds=function(t,n){n=n.toLowerCase(),t=t.toLowerCase();for(var e=new SoundList(this),i=0;i<this.all_sounds.size();i++){var a=this.all_sounds.get(i);""!==t?0===a.name.indexOf(t)&&a.name.toLowerCase().indexOf(n)>=0&&e.add(a):a.name.toLowerCase().indexOf(n)>=0&&e.add(a)}return e},this.onSoundsLoaded=function(){this.ready=!0},this.addRecent=function(n,e){this.recents_played.insertAtBegin(n),this.recents_played.deleteDuplicates(),this.recents_played.keepFirst(10),t.saveRecentsSound(this.recents_played,e)}}function SoundList(t){this.library=t,this.list=[],this.size=function(){return this.list.length},this.get=function(t){return this.list[t]},this.add=function(t){this.list.push(t),t.library=this.library},this.insertAtBegin=function(t){this.list.unshift(t),t.library=this.library},this.deleteDuplicates=function(){for(var t=this.list.length-1;t>=0;t--){var n=this.list[t],e=this.indexOf(n);e<t&&this.list.splice(t,1)}},this.indexOf=function(t){for(var n=!1,e=-1,i=0;i<this.list.length&&!n;){var a=this.list[i];a.name===t.name&&a.duration===t.duration&&(n=!0,e=i),i++}return e},this.keepFirst=function(t){t>=1&&this.list.length>t&&(this.list=this.list.slice(0,t))}}function AppGrid(t){function n(){var n=document.getElementById("grid-cards");for(i=0;i<t.model.listCards.length();i++){var a,o=t.model.listCards.getCard(i);if(o instanceof Card_Text?a=new Widget_Card_Text(this,o):o instanceof Card_Drawing?a=new Widget_Card_Drawing(this,o):o instanceof Card_Sound&&(a=new Widget_Card_Sound(this,o)),"undefined"==typeof a)throw"Type de carte non supporté encore.";this.card_widgets.push(a),a.render(n)}e.call(this),s.call(this)}function e(){var t=this;$(".ripple").on("click",function(n){if(t.isTapHolding)console.log("tap canceled");else{for(var e=$(n.target);!e.attr("cardNumber")&&e.parent();)e=e.parent();var i=e.attr("cardNumber");if(i){var s=t.card_widgets[i];t.busy||(t.busy=!0,a.call(t,n,"ink"),setTimeout(function(){s.onCardThumbnailClick(),t.busy=!1},d))}}})}function a(t,n){var e,i,a,s,o,d=phonegapHandler.app;if(d.loaded){for(e=$(t.target);!e.attr("cardNumber")&&e.parent();)e=e.parent();0===e.find("."+n).length&&e.prepend("<span class='"+n+"'></span>"),i=e.find("."+n),i.removeClass("animate"),i.height()||i.width()||(a=Math.max(e.outerWidth(),e.outerHeight()),i.css({height:a,width:a})),s=t.pageX-e.offset().left-i.width()/2,o=t.pageY-e.offset().top-i.height()/2,i.css({top:o+"px",left:s+"px"}).addClass("animate")}}function s(){var t,n,e,i=this,s=function(){console.log("_onStartTapHolding"),a.call(this,e,"ink-slow"),i.isTapHolding=!0},l=function(){o.call(this,t,n);var a=phonegapHandler.app;if(a.loaded){void 0===a.views.cardConfigurator&&(a.views.cardConfigurator=new CardConfigurator(i));for(var s=$(e.target);!s.attr("cardNumber")&&s.parent();)s=s.parent();var d=s.attr("cardNumber");if(d){var r=i.card_widgets[d];a.views.cardConfigurator.onClick(r)}}i.isTapHolding=!1};$(".ripple").on("mousedown",function(i){e=i,t=setTimeout(s,d),n=setTimeout(l,r)}),$(".ripple").on("mouseup",function(e){o.call(i,t,n)})}function o(t,n){t&&clearTimeout(t),n&&clearTimeout(n),$(".ink-slow").remove(),this.isTapHolding=!1}this.app=t,this.busy=!1,this.isTapHolding=!1,this.card_widgets=[];const d=100,r=750;n.call(this)}function AppMenu(t){function n(){var t=document.getElementById("appmenu"),n={name:"Lyloochat",icon:"check",links:[{longCode:"Afficher un texte",code:"Texte",icon:"keyboard"},{longCode:"Jouer un son",code:"Son",icon:"sound"},{longCode:"Dessiner quelquechose",code:"Dessin",icon:"pen"},{longCode:"Changer les options",code:"Options",icon:"settings"}]};t.innerHTML=Lyloochat.templates.widget_menus(n)}function e(){var t=this,n=$(".app-menu-type-keyboard");n.on("tap",function(e){a.call(t,n)});var e=$(".app-menu-type-sound");e.on("tap",function(n){i.call(t,e)});var d=$("app-menu-type-pen");d.on("tap",function(n){s.call(t,d)});var r=$(".app-menu-type-settings");r.on("tap",function(n){o.call(t,r)})}function i(t){void 0===this.menu_sound&&(this.menu_sound=new AppMenu_Sound(this)),d.call(this,this.menu_sound,t)}function a(t){void 0===this.menu_text,d.call(this,this.menu_text,t)}function s(t){void 0===this.menu_drawing,d.call(this,this.menu_drawing,t)}function o(t){void 0===this.menu_options,d.call(this,this.menu_options,t)}function d(t,n){t===this.selected_menu?(t.hide(),n.removeClass("selected"),this.selected_menu=void 0,this.$selected_menu_elem=void 0,r.call(this)):(void 0!==this.selected_menu&&(this.selected_menu.hide(),this.$selected_menu_elem.removeClass("selected"),this.$selected_menu_elem=void 0,r.call(this)),this.selected_menu=t,t.show(),this.$selected_menu_elem=n,n.addClass("selected"),l.call(this))}function r(){var t=$(".app-content");t.removeClass("freeze-scroll"),t.scrollTop(this.old_scroll_position)}function l(){var t=$(".app-content");this.old_scroll_position=t.scrollTop(),t.addClass("freeze-scroll"),t.scrollTop(0)}this.app=t,this.menu_text=void 0,this.menu_sound=void 0,this.menu_drawing=void 0,this.menu_options=void 0,this.selected_menu=void 0,this.$selected_menu_elem=void 0,this.old_scroll_position=0,n.call(this),e.call(this)}function CardConfigurator(t){function n(){var t=this,n=$(".popup"),d={loc:{title:"Configuration",ok:"OK",cancel:"Annuler",card_text:"Texte",card_sound:"Son",card_drawing:"Dessin",displayed_text:"Texte affiché",played_sound:"Son joué",displayed_draw:"Dessin"}};n.html(Lyloochat.templates.menu_card_config(d)),this.widget.card instanceof Card_Text?a.call(t):this.widget.card instanceof Card_Sound?s.call(t):this.widget.card instanceof Card_Drawing&&o.call(t),Materialize.updateTextFields(),$("ul.tabs").tabs(),$(".btn-sound-search").on("click",function(n){var a=$("#card-soundpath").val();t.appGrid.app.getSoundLibrary(function(n){t.sounds=n.searchSounds("",a);var s=$(".sound-list");for(s.removeClass("hidden"),s.empty(),i=0;i<t.sounds.size();i++){var o=t.sounds.get(i);e.call(t,s,o,i)}})})}function e(t,n){var e={name:n.name,durationStr:n.getDurationStr(),icon:"play"},i=Lyloochat.templates.widget_sound(e);t.append(i);var a=t.children().last(),s=this;a.on("tap",function(t){$("#card-soundpath").val(n.name),s.selectedSound=n})}function a(){$(".menu-card-config ul.tabs").tabs("select_tab","card_text");var t=$("#card_text_content");t.val(this.widget.card.label)}function s(){$(".menu-card-config ul.tabs").tabs("select_tab","card_sound")}function o(){$(".menu-card-config ul.tabs").tabs("select_tab","card_drawing")}this.appGrid=t;this.onClick=function(t){this.busy||(this.busy=!0,this.widget=t,showPopupPanel.call(this),n.call(this))}}function AppMenu_Impl(t){this.appMenu=t,this.displayed=!1,this.show=function(){showErrorPanel("Shouldn't be there you naughty boy !")},this.hide=function(){showErrorPanel("Shouldn't be there you naughty boy !")}}function AppMenu_Sound(t){function n(t,n,e){var i=new Widget_Sound(this,t,n,e);i.insert()}function e(t){o.call(this);var e=$(".app-content");if(""!==t){var a=this.soundLibrary.searchSounds(this.appMenu.app.model.options.prefix,t),s=e.find(".results-list");for(s.empty(),i=0;i<a.size();i++){var d=a.get(i);n.call(this,s,d,!0)}s.removeClass("hidden");var r=e.find(".results-rule");r.removeClass("hidden");var l=e.find(".results-title");l.removeClass("hidden");var h=e.find(".recents-list");h.addClass("hidden"),r=e.find(".recents-rule"),r.addClass("hidden"),l=e.find(".recents-title"),l.addClass("hidden")}else{var c=e.find(".recents-list");c.removeClass("hidden");var u=e.find(".recents-rule");u.removeClass("hidden");var p=e.find(".recents-title");p.removeClass("hidden"),c=e.find(".results-list"),c.addClass("hidden"),u=e.find(".results-rule"),u.addClass("hidden"),p=e.find(".results-title"),p.addClass("hidden")}}function a(){var t=$(".app-content"),e=t.find(".recents-list");for(e.empty(),i=0;i<this.soundLibrary.recents_played.size();i++){var a=this.soundLibrary.recents_played.get(i);n.call(this,e,a,!1)}}function s(){var t=$(".app-content");a.call(this);var n=this,i=t.find(".app-menu-expanded .search-input");i.on("keypress",function(t){var a=t.keyCode?t.keyCode:t.which;13==a&&(t.preventDefault(),console.log("Son cherché : "+i.val()),e.call(n,i.val()),i.blur())})}function o(){void 0!==this.playingWidgetSound&&this.playingWidgetSound.playing&&this.playingWidgetSound.stop()}AppMenu_Impl.apply(this,[t]),this.soundLibrary=void 0;var d=this;this.termSearched="",t.app.getSoundLibrary(function(t){d.soundLibrary=t,d.displayed&&s.call(d)}),this.playingWidgetSound=void 0,this.show=function(){var t={},n=Lyloochat.templates.menu_sound(t),e=$(".app-content");e.append(n),this.displayed=!0,void 0!==this.soundLibrary&&s.call(this)},this.hide=function(){o.call(this);var t=$(".app-content .app-menu-expanded");t.remove(),this.displayed=!1},this.onPlay=function(t,n){var e=this;o.call(e),this.playingWidgetSound=t,this.playingWidgetSound.play(),n&&this.soundLibrary.addRecent(t.sound,function(){a.call(e)})}}function Screen_Card(t){this.widget_card=t,this.display=function(){showErrorPanel("Shouldn't be there you naughty boy !")}}function Screen_Card_Drawing(t){Screen_Card.apply(this,[t])}function Screen_Card_Sound(t){Screen_Card.apply(this,[t])}function Screen_Card_Text(t){Screen_Card.apply(this,[t]),this.display=function(){var n=$("body"),e={label:t.card.label},i=Lyloochat.templates.screen_display_card_text(e);n.append(i);var a=n.children().last(),s=a.find(".container");s.boxfit(),$(window).resize(function(){a.attr("style",""),s.attr("style",""),s.boxfit()});var o=a.find(".card-fs-butt-ok");o.on("click",function(t){$(a).remove()})}}function Widget_Card(t,n){this.appGrid=t,this.card=n,this.elem_card=void 0,this.fullscreen_card=void 0,this.getCardThumbailContent=function(){return showErrorPanel("Shouldn't be there you naughty boy !"),""},this.onCardThumbnailClick=function(){showErrorPanel("Shouldn't be there you naughty boy !")},this.render=function(t){$(t).append(this.getCardThumbailContent.call(this));var n=t.lastElementChild;return this.elem_card=n,""}}function Widget_Card_Drawing(t,n){Widget_Card.apply(this,[t,n]),this.getCardThumbailContent=function(){var t={cardNumber:n.id,title:n.code};return Lyloochat.templates.widget_card_text(t)},this.onCardThumbnailClick=function(){showErrorPanel("Click Widget_Card_Drawing")}}function Widget_Card_Sound(t,n){Widget_Card.apply(this,[t,n]),this.getCardThumbailContent=function(){var t={cardNumber:n.id,title:n.code};return Lyloochat.templates.widget_card_text(t)},this.onCardThumbnailClick=function(){showErrorPanel("Click Widget_Card_Sound")}}function Widget_Card_Text(t,n){Widget_Card.apply(this,[t,n]),this.getCardThumbailContent=function(){var t={cardNumber:n.id,title:n.code};return Lyloochat.templates.widget_card_text(t)},this.onCardThumbnailClick=function(){this.displayed_screen_card=new Screen_Card_Text(this),this.displayed_screen_card.display()}}function Widget_Sound(t,n,e,i){function a(){this.playing=!1,this.$elem_sound.removeClass("selected");var t=this.$elem_sound.find(".sound-icon");t.removeClass("icon-pause"),t.addClass("icon-play")}function s(t){var n=this;void 0===this.soundHandler?this.appMenuSound.appMenu.app.deviceHandler.createSoundHandler(this.sound,function(){a.call(n)},function(e){n.soundHandler=e,t(n.soundHandler)}):t(this.soundHandler)}this.$elem_parent=n,this.$elem_sound=void 0,this.sound=e,this.appMenuSound=t,this.playing=!1,this.addToRecent=i,this.insert=function(){var t={name:this.sound.name,durationStr:this.sound.getDurationStr(),icon:"play"},n=Lyloochat.templates.widget_sound(t);this.$elem_parent.append(n),this.$elem_sound=this.$elem_parent.children().last();var e=this;this.$elem_sound.on("tap",function(t){e.playing?e.stop():e.appMenuSound.onPlay(e,e.addToRecent)})},this.play=function(){var t=this;this.playing=!0,s.call(t,function(n){n.play(),t.$elem_sound.addClass("selected");var e=t.$elem_sound.find(".sound-icon");e.removeClass("icon-play"),e.addClass("icon-pause")})},this.stop=function(){var t=this;s.call(t,function(n){n.stop(),n.release(),a.call(t)})}}!function(t,n){n.inner_showMaskPanel=function(t,e,i){var a=n(".mask");a.html(""),a.addClass("visible"),e&&a.on("click",function(n){i.call(t)})},n.inner_hideMaskPanel=function(t){var e=n(".mask");e.html(""),e.removeClass("visible"),e.off("click")},n.inner_showPopupPanel=function(t){var e=n(".popup");e.html(""),e.addClass("visible")},n.inner_hidePopupPanel=function(t){var e=n(".popup");e.html(""),e.removeClass("visible")},n.inner_showErrorPanel=function(t,e){n.inner_showMaskPanel(this,!0,hideErrorPanel);var i=n(".mask"),a={type:"error",header:{icon:"sad",message:"Onoz !"},messages:[e],footer:{buttons:["ok"]}};i.html(Lyloochat.templates.widget_dialog(a))},n.inner_hideErrorPanel=function(t){n.inner_hideMaskPanel(t)},n.inner_showLoadingPanel=function(t,e){n.inner_showMaskPanel(this,!1,hideLoadingPanel);var i=n(".mask"),a={type:"loading",messages:[e]};i.html(Lyloochat.templates.widget_dialog(a))},n.inner_hideLoadingPanel=function(t){n.inner_hideMaskPanel(t)}}(window,jQuery),Handlebars.registerHelper("if_eq",function(t,n,e){return t===n?e.fn(this):e.inverse(this)});